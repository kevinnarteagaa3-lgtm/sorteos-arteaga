<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sorteos Arteaga</title>
<style>
:root{--bg:#000;--gold:#d4af37;--panel:#111;--muted:#aaa;--text:#fff}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial,sans-serif}
header{padding:18px;text-align:center;border-bottom:3px solid var(--gold)}
header img{width:120px;border-radius:8px}
.container{max-width:1024px;margin:18px auto;padding:12px}
.card{background:var(--panel);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px}
.input,select{padding:10px;border-radius:8px;border:1px solid #222;background:#0f0f0f;color:var(--text)}
.btn{background:var(--gold);color:#000;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
#numeros{display:grid;grid-template-columns:repeat(auto-fill,minmax(56px,1fr));gap:8px;margin-top:12px}
.num{background:#141414;border:1px solid #222;padding:10px;border-radius:8px;text-align:center;cursor:pointer;font-weight:700;color:var(--text)}
.num.vendido{background:#111;color:#555;cursor:not-allowed;border-color:#333}
.num.seleccionado{background:var(--gold);color:#000;border-color:var(--gold)}
.footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
.info-row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:12px}
.badge{background:#0d0d0d;padding:8px 10px;border-radius:8px;border:1px solid #222}
</style>
</head>
<body>
<header>
  <img id="logo" src="" alt="Logo Sorteos Arteaga">
  <h1 style="margin:6px 0; color:var(--gold)">Sorteos Arteaga</h1>
</header>

<main class="container">
  <div class="card">
    <div id="descripcion">Cargando informaci√≥n...</div>

    <div class="info-row">
      <div class="badge">Precio: <span id="precio">-</span></div>
      <div class="badge">Promos: <span id="promos">-</span></div>
      <div class="badge">Pago: <span id="mp">-</span></div>
    </div>

    <div style="margin-top:12px">
      <strong>Maquinita de la suerte</strong>
      <div class="controls" style="margin-top:8px">
        <select id="maquinaOpt" class="input">
          <option value="1">Generar 1</option>
          <option value="2">Generar 2</option>
          <option value="3">Generar 3</option>
          <option value="4">Generar 4</option>
          <option value="10">Generar 10</option>
          <option value="100">Generar 100</option>
        </select>
        <button class="btn" id="btnGirar">üé∞ Girar</button>
        <button class="btn" id="btnSelAll">Seleccionar todos</button>
        <button class="btn" id="btnLimpiar">Limpiar selecci√≥n</button>
      </div>
    </div>

    <h3 style="margin-top:12px">Lista de boletos</h3>
    <div id="numeros"></div>

    <div style="margin-top:14px" class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
        <input id="nombre" class="input" placeholder="Nombre completo" style="min-width:200px">
        <input id="telefono" class="input" placeholder="Tel√©fono (ej. 521...)">
        <select id="estado" class="input">
          <option value="">Selecciona estado</option>
          <option>Aguascalientes</option><option>Baja California</option><option>Baja California Sur</option>
          <option>Campeche</option><option>Chiapas</option><option>Chihuahua</option><option>Coahuila</option>
          <option>Colima</option><option>Durango</option><option>Estado de M√©xico</option><option>Guanajuato</option>
          <option>Guerrero</option><option>Hidalgo</option><option>Jalisco</option><option>Michoac√°n</option>
          <option>Morelos</option><option>Nayarit</option><option>Nuevo Le√≥n</option><option>Oaxaca</option>
          <option>Puebla</option><option>Quer√©taro</option><option>Quintana Roo</option><option>San Luis Potos√≠</option>
          <option>Sinaloa</option><option>Sonora</option><option>Tabasco</option><option>Tamaulipas</option>
          <option>Tlaxcala</option><option>Veracruz</option><option>Yucat√°n</option><option>Zacatecas</option>
          <option>Ciudad de M√©xico</option>
        </select>
      </div>

      <div style="text-align:center;margin-top:12px">
        <button class="btn" id="btnApartar">üì≤ Apartar y enviar por WhatsApp</button>
      </div>

      <div id="seleccion" style="margin-top:12px;color:var(--gold);font-weight:700">Selecci√≥n: ‚Äî</div>
    </div>

  </div>

  <div class="footer">
    ¬© Sorteos Arteaga ‚Äî Legalidad y transparencia (basados en Loter√≠a Nacional)
  </div>
</main>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzl8-sfJRysbmx8ohQbNbmG-1jt0zX15s5Foth6bordIO_JPkEVPks681EZBSEo_7hUtQ/exec";
let CONFIG = null;
let seleccion = new Set();

async function cargar() {
  try {
    const r = await fetch(SCRIPT_URL);
    CONFIG = await r.json();
    document.getElementById('logo').src = CONFIG.logo || '';
    document.getElementById('descripcion').textContent = CONFIG.descripcion || '';
    document.getElementById('precio').textContent = CONFIG.precio ? `$${CONFIG.precio}` : '-';
    document.getElementById('promos').textContent = CONFIG.promociones || '-';
    document.getElementById('mp').textContent = CONFIG.metodos_pago || '-';
    generarLista(Number(CONFIG.emisiones) || 100);
  } catch (e) {
    console.error(e);
    document.getElementById('descripcion').textContent = 'No fue posible cargar datos.';
  }
}

function generarLista(total){
  const cont = document.getElementById('numeros');
  cont.innerHTML = '';
  const vendidos = (CONFIG.boletos_vendidos || "").toString().split(",").map(s=>s.trim()).filter(Boolean);
  for (let i=1;i<=total;i++){
    const n = String(i).padStart(1,'0'); // mantengo simple (sin ceros a la izquierda largos)
    const el = document.createElement('div');
    el.className = 'num';
    el.textContent = i;
    if (vendidos.includes(i.toString())) {
      el.classList.add('vendido');
    } else {
      el.addEventListener('click', ()=>toggle(i, el));
    }
    cont.appendChild(el);
  }
  actualizarSeleccionUI();
}

function toggle(num, el){
  if (seleccion.has(num)) {
    seleccion.delete(num);
    el.classList.remove('seleccionado');
  } else {
    seleccion.add(num);
    el.classList.add('seleccionado');
  }
  actualizarSeleccionUI();
}

function actualizarSeleccionUI(){
  const arr = Array.from(seleccion).sort((a,b)=>a-b);
  document.getElementById('seleccion').textContent = arr.length ? ' ' + arr.join(', ') : '‚Äî';
}

document.getElementById('btnSelAll').addEventListener('click', ()=>{
  seleccion.clear();
  const nodes = document.querySelectorAll('.num:not(.vendido)');
  nodes.forEach(n => { seleccion.add(Number(n.textContent)); n.classList.add('seleccionado'); });
  actualizarSeleccionUI();
});
document.getElementById('btnLimpiar').addEventListener('click', ()=>{
  seleccion.clear();
  document.querySelectorAll('.num.seleccionado').forEach(n=>n.classList.remove('seleccionado'));
  actualizarSeleccionUI();
});

document.getElementById('btnGirar').addEventListener('click', ()=>{
  const opt = Number(document.getElementById('maquinaOpt').value);
  const libres = Array.from(document.querySelectorAll('.num:not(.vendido)')).map(n=>Number(n.textContent));
  if (libres.length===0) return alert('No hay boletos disponibles.');
  const picks = [];
  const count = Math.min(opt, libres.length);
  for (let i=0;i<count;i++){
    const idx = Math.floor(Math.random()*libres.length);
    picks.push(libres.splice(idx,1)[0]);
  }
  // marcar selecci√≥n
  picks.forEach(p=>{
    const node = [...document.querySelectorAll('.num')].find(n=>Number(n.textContent)===p);
    if (node) node.classList.add('seleccionado');
    seleccion.add(p);
  });
  actualizarSeleccionUI();
});

document.getElementById('btnApartar').addEventListener('click', async ()=>{
  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const estado = document.getElementById('estado').value;
  if (!nombre || !telefono || !estado) return alert('Completa nombre, tel√©fono y estado.');
  if (seleccion.size===0) return alert('Selecciona al menos un n√∫mero.');

  const nums = Array.from(seleccion).sort((a,b)=>a-b);
  // arma mensaje para WhatsApp
  const wa = CONFIG.whatsapp ? CONFIG.whatsapp.toString() : document.getElementById('telefono').value.replace(/\D/g,'');
  const text = `Hola, deseo apartar estos boletos: ${nums.join(', ')}.%0ANombre: ${encodeURIComponent(nombre)}%0ATel√©fono: ${encodeURIComponent(telefono)}%0AEstado: ${encodeURIComponent(estado)}%0Aprecio_por_boleto: ${encodeURIComponent(CONFIG.precio||'')}%0APromociones: ${encodeURIComponent(CONFIG.promociones||'')}`;

  // abrir WhatsApp
  window.open(`https://wa.me/${wa}?text=${text}`, '_blank');

  // intentamos guardar el apartado en Sheets v√≠a POST
  const payload = {
    action: "apartar",
    numeros: nums,
    nombre, telefono, estado,
    fecha: new Date().toISOString()
  };

  try {
    const resp = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const txt = await resp.text();
    alert('Apartado enviado. ' + txt);
    // refrescar la configuraci√≥n para ver si se actualizaron vendidos
    setTimeout(()=> location.reload(), 1200);
  } catch (err) {
    console.error(err);
    alert('No se pudo guardar el apartado en Sheets (revisa permisos/URL).');
  }
});

cargar();
</script>
</body>
</html>
