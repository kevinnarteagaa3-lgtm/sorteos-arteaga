<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sorteos Arteaga</title>
<style>
  :root { --bg:#0b0b0b; --panel:#111; --accent:#ffd700; --muted:#999; }
  body{margin:0;background:var(--bg);color:#fff;font-family:Arial,Helvetica,sans-serif}
  header{background:var(--panel);padding:14px;text-align:center}
  header h1{color:var(--accent);margin:0}
  .container{max-width:1100px;margin:18px auto;padding:0 14px}
  .logo img{width:140px;border-radius:8px;display:block;margin:12px auto}
  .descripcion{background:#121212;padding:12px;border-radius:8px;margin:12px 0;color:#ddd}
  .carrusel{display:flex;gap:10px;overflow:auto;padding:10px;margin:10px 0}
  .carrusel img{height:140px;border-radius:8px;object-fit:cover}
  .boletos{display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:8px;margin-top:14px}
  .boleto{background:#fff;color:#000;padding:12px;border-radius:8px;cursor:pointer;font-weight:700;user-select:none}
  .boleto.vendido{background:#000;color:var(--muted);cursor:not-allowed}
  .seleccionado{background:var(--accent);color:#000}
  .form{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:14px}
  input,select{padding:10px;border-radius:8px;border:0;min-width:160px}
  button{background:var(--accent);color:#000;padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:800}
  .maquinita{background:#111;padding:12px;border-radius:8px;margin-top:14px;text-align:left}
  footer{padding:18px;text-align:center;color:#bbb;margin-top:18px}
  #resultado{color:#fff;margin-top:8px}
</style>
</head>
<body>
  <header><h1>Sorteos Arteaga</h1></header>

  <div class="container">
    <div class="logo" id="logoWrap"></div>
    <div class="descripcion" id="descripcion">Cargando informaciÃ³n...</div>

    <div class="carrusel" id="carrusel"></div>

    <h3 style="color:var(--accent)">Lista de boletos</h3>
    <div class="boletos" id="boletos"></div>

    <div class="form">
      <input id="nombre" placeholder="Tu nombre">
      <input id="telefono" placeholder="Tu nÃºmero (ej. 521...)">
      <select id="estado">
        <option value="">Selecciona tu estado</option>
        <option>Aguascalientes</option><option>Baja California</option><option>Baja California Sur</option>
        <option>Campeche</option><option>Chiapas</option><option>Chihuahua</option><option>Coahuila</option>
        <option>Colima</option><option>Durango</option><option>Estado de MÃ©xico</option><option>Guanajuato</option>
        <option>Guerrero</option><option>Hidalgo</option><option>Jalisco</option><option>MichoacÃ¡n</option>
        <option>Morelos</option><option>Nayarit</option><option>Nuevo LeÃ³n</option><option>Oaxaca</option>
        <option>Puebla</option><option>QuerÃ©taro</option><option>Quintana Roo</option><option>San Luis PotosÃ­</option>
        <option>Sinaloa</option><option>Sonora</option><option>Tabasco</option><option>Tamaulipas</option>
        <option>Tlaxcala</option><option>Veracruz</option><option>YucatÃ¡n</option><option>Zacatecas</option>
        <option>Ciudad de MÃ©xico</option>
      </select>

      <button id="btnApartar">ðŸ“² Apartar y enviar por WhatsApp</button>
    </div>

    <div class="maquinita">
      <strong>ðŸŽ° Maquinita de la suerte</strong>
      <div style="margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <label style="color:#ddd">Generar:</label>
        <input id="cantidadRandom" type="number" min="1" max="10000" value="1" style="width:90px">
        <button id="btnMaquinita">Girar</button>
      </div>
      <div id="resultado"></div>
    </div>

    <div style="margin-top:18px;color:#ccc">
      <strong>Precio por boleto:</strong> <span id="precio">-</span><br>
      <strong>Promociones:</strong> <span id="promos">-</span><br>
      <strong>MÃ©todos de pago:</strong> <span id="mp">-</span>
    </div>
  </div>

  <footer>ðŸ”’ Legalidad y transparencia: Basados en la LoterÃ­a Nacional â€” Â© Sorteos Arteaga</footer>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPp68HnzJ_1TtmLbS4neM1r7Mc9SbWlP0iwj6FviHZmCMC5P81KODTGKldLh7Tpj6CWw/exec";

  let config = null;
  let seleccionados = [];

  async function cargar() {
    try {
      const r = await fetch(SCRIPT_URL);
      config = await r.json();
      // logo
      document.getElementById('logoWrap').innerHTML = config.logo ? `<img src="${config.logo}" alt="logo" style="max-width:160px;border-radius:8px">` : '';
      document.getElementById('descripcion').textContent = config.descripcion || '';
      // carrusel
      const carr = document.getElementById('carrusel'); carr.innerHTML = '';
      const fotos = Array.isArray(config.fotos) ? config.fotos : (config.fotos ? config.fotos.toString().split(",").map(s=>s.trim()) : []);
      fotos.forEach(src=>{
        const img = document.createElement('img'); img.src = src; carr.appendChild(img);
      });
      // precio / promos / mp
      document.getElementById('precio').textContent = config.precio || "-";
      document.getElementById('promos').textContent = config.promociones || "-";
      document.getElementById('mp').textContent = config.metodos_pago || "-";
      // boletos
      renderBoletos();
    } catch (err) {
      console.error(err);
      document.getElementById('descripcion').textContent = 'No se pudieron cargar los datos. Comprueba el script URL y permisos.';
    }
  }

  function renderBoletos(){
    const cont = document.getElementById('boletos'); cont.innerHTML = '';
    const total = Number(config.emisiones) || 0;
    const vendidos = (config.boletos_vendidos || "").toString().split(",").map(s=>s.trim()).filter(Boolean).map(Number);
    const soldSet = new Set(vendidos);
    for (let i=1;i<=total;i++){
      const el = document.createElement('div');
      el.className = 'boleto';
      el.textContent = i;
      if (soldSet.has(i)) {
        el.classList.add('vendido');
      } else {
        el.addEventListener('click', ()=> toggleSelect(i, el));
      }
      cont.appendChild(el);
    }
  }

  function toggleSelect(num, el){
    const idx = seleccionados.indexOf(num);
    if (idx>=0){
      seleccionados.splice(idx,1);
      el.classList.remove('seleccionado');
      el.style.background='';
    } else {
      seleccionados.push(num);
      el.classList.add('seleccionado');
      el.style.background='#9f9';
    }
  }

  document.getElementById('btnApartar').addEventListener('click', async ()=>{
    const nombre = document.getElementById('nombre').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const estado = document.getElementById('estado').value;
    if (!nombre || !telefono || !estado) { alert('Completa nombre, telÃ©fono y estado.'); return; }
    if (seleccionados.length===0){ alert('Selecciona al menos un nÃºmero.'); return; }

    // abrir WhatsApp al admin
    const adminPhone = config.whatsapp || telefono.replace(/\D/g,'');
    const msg = `Hola! Quiero apartar los boletos: ${seleccionados.join(', ')}.%0ANombre: ${encodeURIComponent(nombre)}%0ATelÃ©fono: ${encodeURIComponent(telefono)}%0AEstado: ${encodeURIComponent(estado)}%0APrecio por boleto: ${encodeURIComponent(config.precio || '')}%0APromociones: ${encodeURIComponent(config.promociones || '')}%0AMÃ©todos de pago: ${encodeURIComponent(config.metodos_pago || '')}`;
    window.open(`https://wa.me/${adminPhone}?text=${msg}`, '_blank');

    // registrar apartado en Sheets (POST action "apartar")
    try {
      const resp = await fetch(SCRIPT_URL, {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ action: 'apartar', numeros: seleccionados, nombre, telefono, estado })
      });
      const txt = await resp.text();
      alert('Apartado enviado. ' + txt);
      // refrescar para mostrar boletos vendidos actualizados (si script actualiza)
      setTimeout(()=> cargar(), 1200);
      seleccionados = [];
    } catch (err) {
      console.error(err);
      alert('No se pudo guardar el apartado en Sheets.');
    }
  });

  // Maquinita
  document.getElementById('btnMaquinita').addEventListener('click', ()=>{
    const n = Number(document.getElementById('cantidadRandom').value) || 1;
    const total = Number(config.emisiones) || 0;
    const vendidos = (config.boletos_vendidos || "").toString().split(",").map(s=>s.trim()).filter(Boolean).map(Number);
    const available = [];
    for (let i=1;i<=total;i++) if (!vendidos.includes(i)) available.push(i);
    const count = Math.min(n, available.length);
    const picks = [];
    for (let i=0;i<count;i++){
      const idx = Math.floor(Math.random()*available.length);
      picks.push(available.splice(idx,1)[0]);
    }
    // marcar visualmente
    picks.forEach(p=>{
      const nodes = Array.from(document.querySelectorAll('.boleto'));
      const node = nodes.find(n=>n.textContent==p.toString());
      if (node){ node.style.background='#9f9'; node.classList.add('seleccionado'); }
    });
    seleccionados = Array.from(new Set([...seleccionados, ...picks]));
    document.getElementById('resultado').textContent = 'Maquinita generÃ³: ' + picks.join(', ');
  });

  // carga inicial
  cargar();
</script>
</body>
</html>
